<!doctype html>
<html lang="ja">
<head prefix="og: http://ogp.me/ns#">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">
<title>dplyr: 高速data.frame処理 - Heavy Watal</title>
<link rel="stylesheet" href="/css/style.css">
<link rel="icon" href="/favicon.svg">
<link rel="apple-touch-icon" href="/apple-touch-icon.png" sizes="180x180">
<link rel="manifest" href="/manifest.webmanifest">
<meta name="theme-color" content="#eeeeee">
<meta name="author" content="Watal M. Iwasaki">
<meta property="og:title" content="dplyr: 高速data.frame処理">
<meta property="og:type" content="article">
<meta property="og:url" content="https://heavywatal.github.io/rstats/dplyr.html">
<meta property="og:image" content="https://avatars.githubusercontent.com/heavywatal">
<meta property="og:description" content="">
<meta property="og:site_name" content="Heavy Watal">
<meta name="twitter:card" content="summary">
<meta name="twitter:site" content="@heavywatal">
<meta name="twitter:creator" content="@heavywatal">
<link rel="stylesheet" href="/lib/iconify.css">
<link rel="stylesheet" href="/lib/katex/katex.min.css">
<script type="module" src="/lib/katex/katex.min.js"></script>
<script type="application/ld+json">{
"@context": "http://schema.org",
"@type": "BreadcrumbList",
"itemListElement": [
 {"@type": "ListItem",
  "position": 1,
  "item": {"@id": "https://heavywatal.github.io/rstats/", "name": "rstats" }},
 {"@type": "ListItem",
  "position": 2,
  "item": {"@id": "https://heavywatal.github.io/rstats/dplyr.html", "name": "dplyr" }}
]}</script>

<script async src="https://www.googletagmanager.com/gtag/js?id=G-V60H2JH0G6"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-V60H2JH0G6');
</script>
</head>
<body>
<header>
<a href="/">
<img class="logo" src="/heavywatal.svg" alt="岩嵜航"><span class="site-title">Heavy Watal</span>
</a>
<search><form action="/search.html">
<input type="search" name="q" placeholder="search">
</form></search>
</header>
<main>
<article>
<header><h1><a href="/rstats/dplyr.html">
dplyr — 高速data.frame処理
</a></h1>
<nav class="tags">
<a href="/tags/r.html">r</a>
<a href="/tags/tidyverse.html">tidyverse</a>
</nav>
</header>

<a href="https://dplyr.tidyverse.org/">
<img src="/_img/hex-stickers/dplyr.webp" style="float: right;" width="120" height="139">
</a>
<p>data.frameに対して抽出(select, filter)、部分的変更(mutate)、要約(summarize)、ソート(arrange)などの処理を施すためのパッケージ。
前作plyrのうちdata.frameに関する部分が強化されている。
<a href="/rstats/purrr.html">purrr</a> や <a href="/rstats/tidyr.html">tidyr</a> と一緒に使うとよい。</p>
<p><a href="https://tidyverse.tidyverse.org/">tidyverse</a> に含まれているので、
<code>install.packages(&quot;tidyverse&quot;)</code> で一括インストール、
<code>library(tidyverse)</code> で一括ロード。</p>
<ul>
<li><a href="https://r4ds.hadley.nz/data-transform.html">https://r4ds.hadley.nz/data-transform.html</a></li>
<li><a href="https://github.com/tidyverse/dplyr">https://github.com/tidyverse/dplyr</a></li>
</ul>
<h2 id="パイプ演算子--による関数の連結">パイプ演算子 |&gt; による関数の連結</h2>
<a href="https://magrittr.tidyverse.org/">
<img src="/_img/hex-stickers/pipe.webp" style="float: right;" width="120" height="139">
</a>
<p><code>x |&gt; f(a, b)</code> は <code>f(x, a, b)</code> と等価。
左の値 <code>x</code> を第一引数として右の関数 <code>f()</code> に渡す。
一時変数を作ったり、関数を何重にも重ねたりすることなく、
適用する順に次々と処理を記述することができるようになる。
慣れれば書きやすく読みやすい。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="nf">library</span><span class="p">(</span><span class="n">conflicted</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nf">library</span><span class="p">(</span><span class="n">tidyverse</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">result</span> <span class="o">=</span> <span class="n">diamonds</span> <span class="o">|&gt;</span>                   <span class="c1"># 生データから出発して</span>
</span></span><span class="line"><span class="cl">  <span class="n">dplyr</span><span class="o">::</span><span class="nf">select</span><span class="p">(</span><span class="n">carat</span><span class="p">,</span> <span class="n">cut</span><span class="p">,</span> <span class="n">price</span><span class="p">)</span> <span class="o">|&gt;</span>  <span class="c1"># 列を抽出して</span>
</span></span><span class="line"><span class="cl">  <span class="n">dplyr</span><span class="o">::</span><span class="nf">filter</span><span class="p">(</span><span class="n">carat</span> <span class="o">&gt;</span> <span class="m">1</span><span class="p">)</span> <span class="o">|&gt;</span>          <span class="c1"># 行を抽出して</span>
</span></span><span class="line"><span class="cl">  <span class="n">dplyr</span><span class="o">::</span><span class="nf">group_by</span><span class="p">(</span><span class="n">cut</span><span class="p">)</span> <span class="o">|&gt;</span>              <span class="c1"># グループ化して</span>
</span></span><span class="line"><span class="cl">  <span class="n">dplyr</span><span class="o">::</span><span class="nf">summarize</span><span class="p">(</span><span class="nf">mean</span><span class="p">(</span><span class="n">price</span><span class="p">))</span> <span class="o">|&gt;</span>     <span class="c1"># 平均を計算</span>
</span></span><span class="line"><span class="cl">  <span class="nf">print</span><span class="p">()</span>                              <span class="c1"># 表示してみる</span>
</span></span></code></pre></div><pre tabindex="0"><code>        cut mean(price)
1      Fair    7177.856
2      Good    7753.601
3 Very Good    8340.549
4   Premium    8487.249
5     Ideal    8674.227
</code></pre><p>同じことをパイプなしでやると読みにくい:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="c1">## with a temporary variable</span>
</span></span><span class="line"><span class="cl"><span class="n">result</span> <span class="o">=</span> <span class="n">dplyr</span><span class="o">::</span><span class="nf">select</span><span class="p">(</span><span class="n">diamonds</span><span class="p">,</span> <span class="n">carat</span><span class="p">,</span> <span class="n">cut</span><span class="p">,</span> <span class="n">price</span><span class="p">)</span> <span class="c1"># 列を抽出して</span>
</span></span><span class="line"><span class="cl"><span class="n">result</span> <span class="o">=</span> <span class="n">dplyr</span><span class="o">::</span><span class="nf">filter</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">carat</span> <span class="o">&gt;</span> <span class="m">1</span><span class="p">)</span>           <span class="c1"># 行を抽出して</span>
</span></span><span class="line"><span class="cl"><span class="n">result</span> <span class="o">=</span> <span class="n">dplyr</span><span class="o">::</span><span class="nf">group_by</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">cut</span><span class="p">)</span>               <span class="c1"># グループ化して</span>
</span></span><span class="line"><span class="cl"><span class="n">result</span> <span class="o">=</span> <span class="n">dplyr</span><span class="o">::</span><span class="nf">summarize</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="nf">mean</span><span class="p">(</span><span class="n">price</span><span class="p">))</span>      <span class="c1"># 平均を計算</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">## with nested functions</span>
</span></span><span class="line"><span class="cl"><span class="n">result</span> <span class="o">=</span> <span class="n">dplyr</span><span class="o">::</span><span class="nf">summarize</span><span class="p">(</span>              <span class="c1"># 平均を計算</span>
</span></span><span class="line"><span class="cl">    <span class="n">dplyr</span><span class="o">::</span><span class="nf">group_by</span><span class="p">(</span>                        <span class="c1"># グループ化して</span>
</span></span><span class="line"><span class="cl">      <span class="n">dplyr</span><span class="o">::</span><span class="nf">filter</span><span class="p">(</span>                            <span class="c1"># 行を抽出して</span>
</span></span><span class="line"><span class="cl">        <span class="n">dplyr</span><span class="o">::</span><span class="nf">select</span><span class="p">(</span><span class="n">diamonds</span><span class="p">,</span> <span class="n">carat</span><span class="p">,</span> <span class="n">cut</span><span class="p">,</span> <span class="n">price</span><span class="p">),</span> <span class="c1"># 列を抽出して</span>
</span></span><span class="line"><span class="cl">        <span class="n">carat</span> <span class="o">&gt;</span> <span class="m">1</span><span class="p">),</span>                             <span class="c1"># 行を抽出して</span>
</span></span><span class="line"><span class="cl">      <span class="n">cut</span><span class="p">),</span>                                 <span class="c1"># グループ化して</span>
</span></span><span class="line"><span class="cl">    <span class="nf">mean</span><span class="p">(</span><span class="n">price</span><span class="p">))</span>                        <span class="c1"># 平均を計算</span>
</span></span></code></pre></div><p>R 4.1 から標準で <code>|&gt;</code> が使えるようになり、徐々に普及してきた。
それまでdplyr始めtidyverseでは
<a href="https://magrittr.tidyverse.org/">magrittr</a> の <code>%&gt;%</code> が長らく使われていた。
R 4.2 の段階では <code>|&gt;</code> のプレースホルダー <code>_</code> の使い勝手がイマイチなので、
<code>%&gt;%</code> から完全移行できる状態ではない。</p>
<p>さらに高性能なものを求める人々は
<a href="https://renkun-ken.github.io/pipeR/"><code>pipeR</code></a> パッケージの <code>%&gt;&gt;%</code>
を使っていたが最近はあまり見かけない。</p>
<h2 id="抽出絞り込み">抽出・絞り込み</h2>
<h3 id="列">列</h3>
<dl>
<dt><a href="https://dplyr.tidyverse.org/reference/select.html"><code>dplyr::select(.data, ...)</code></a></dt>
<dd>列を絞る。<code>:</code>範囲指定、<code>!</code>負の指定が可能。
<a href="https://tidyselect.r-lib.org/reference/language.html">selection helpers</a>
によるパターン指定も便利。
複数の条件を組み合わせるには <code>&amp;</code> (AND), <code>|</code> (OR) で。
残るのが1列だけでも勝手にvectorにはならずdata.frameのまま。
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">diamonds</span> <span class="o">|&gt;</span> <span class="n">dplyr</span><span class="o">::</span><span class="nf">select</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="m">2</span><span class="p">,</span> <span class="m">7</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">diamonds</span> <span class="o">|&gt;</span> <span class="n">dplyr</span><span class="o">::</span><span class="nf">select</span><span class="p">(</span><span class="n">carat</span><span class="p">,</span> <span class="n">cut</span><span class="p">,</span> <span class="n">price</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">diamonds</span> <span class="o">|&gt;</span> <span class="n">dplyr</span><span class="o">::</span><span class="nf">select</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="s">&#34;carat&#34;</span><span class="p">,</span> <span class="s">&#34;cut&#34;</span><span class="p">,</span> <span class="s">&#34;price&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">diamonds</span> <span class="o">|&gt;</span> <span class="n">dplyr</span><span class="o">::</span><span class="nf">select</span><span class="p">(</span><span class="o">!</span><span class="nf">c</span><span class="p">(</span><span class="n">carat</span><span class="p">,</span> <span class="n">cut</span><span class="p">,</span> <span class="n">price</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">diamonds</span> <span class="o">|&gt;</span> <span class="n">dplyr</span><span class="o">::</span><span class="nf">select</span><span class="p">(</span><span class="nf">starts_with</span><span class="p">(</span><span class="s">&#34;c&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">diamonds</span> <span class="o">|&gt;</span> <span class="n">dplyr</span><span class="o">::</span><span class="nf">select</span><span class="p">(</span><span class="nf">where</span><span class="p">(</span><span class="n">is.numeric</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="c1"># diamonds |&gt; dplyr::select(-carat, -cut, -price)</span>
</span></span></code></pre></div><p>カンマ区切りはORの意味で働くはずだがマイナス指定
<code>dplyr::select(-carat, -cut, -price)</code>
の場合だけANDのように働く(つまり3列とも抜ける)ので特殊。
(だからマニュアルから消えたのかな？)</p>
</dd>
<dd>
<p>文字列ベクタで指定しようとすると意図が曖昧になるので、
<a href="https://tidyselect.r-lib.org/reference/all_of.html">ヘルパー関数 <code>all_of()</code>, <code>any_of()</code></a>を挟む。あるいは
<a href="https://rlang.r-lib.org/reference/embrace-operator.html">{{embrace}}</a>,
<a href="https://adv-r.hadley.nz/quasiquotation.html">!!unquoting</a>,
<a href="https://rlang.r-lib.org/reference/dot-data.html">pronoun$</a>を使う:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">clarity</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="s">&#34;carat&#34;</span><span class="p">,</span> <span class="s">&#34;cut&#34;</span><span class="p">,</span> <span class="s">&#34;price&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">diamonds</span> <span class="o">|&gt;</span> <span class="n">dplyr</span><span class="o">::</span><span class="nf">select</span><span class="p">(</span><span class="n">clarity</span><span class="p">)</span>         <span class="c1"># ambiguous!</span>
</span></span><span class="line"><span class="cl"><span class="n">diamonds</span> <span class="o">|&gt;</span> <span class="n">dplyr</span><span class="o">::</span><span class="nf">select</span><span class="p">(</span><span class="n">.data</span><span class="o">$</span><span class="n">clarity</span><span class="p">)</span>   <span class="c1"># clarity</span>
</span></span><span class="line"><span class="cl"><span class="n">diamonds</span> <span class="o">|&gt;</span> <span class="n">dplyr</span><span class="o">::</span><span class="nf">select</span><span class="p">(</span><span class="nf">all_of</span><span class="p">(</span><span class="n">clarity</span><span class="p">))</span> <span class="c1"># carat, cut, price</span>
</span></span><span class="line"><span class="cl"><span class="n">diamonds</span> <span class="o">|&gt;</span> <span class="n">dplyr</span><span class="o">::</span><span class="nf">select</span><span class="p">(</span><span class="nf">any_of</span><span class="p">(</span><span class="n">clarity</span><span class="p">))</span> <span class="c1"># carat, cut, price</span>
</span></span><span class="line"><span class="cl"><span class="n">diamonds</span> <span class="o">|&gt;</span> <span class="n">dplyr</span><span class="o">::</span><span class="nf">select</span><span class="p">({{</span><span class="n">clarity</span><span class="p">}})</span>     <span class="c1"># carat, cut, price</span>
</span></span><span class="line"><span class="cl"><span class="n">diamonds</span> <span class="o">|&gt;</span> <span class="n">dplyr</span><span class="o">::</span><span class="nf">select</span><span class="p">(</span><span class="o">!!</span><span class="n">clarity</span><span class="p">)</span>       <span class="c1"># carat, cut, price</span>
</span></span><span class="line"><span class="cl"><span class="n">diamonds</span> <span class="o">|&gt;</span> <span class="n">dplyr</span><span class="o">::</span><span class="nf">select</span><span class="p">(</span><span class="o">!!!</span><span class="n">rlang</span><span class="o">::</span><span class="nf">syms</span><span class="p">(</span><span class="n">clarity</span><span class="p">))</span>  <span class="c1"># carat, cut, price</span>
</span></span></code></pre></div><p>これらの指定方法は <code>rename()</code> や <code>pull()</code> でも有効。</p>
<p>一方、文字列を受け取れない <code>distinct()</code> や <code>group_by()</code>
などの関数には普通のunquoteは通用しない。
最後の例のように <code>rlang::data_syms()</code> でシンボルのリストを作って
<a href="https://rlang.r-lib.org/reference/splice-operator.html">!!!unquote-splicing</a>
して渡す必要がある。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">columns</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="s">&#34;cut&#34;</span><span class="p">,</span> <span class="s">&#34;color&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">diamonds</span> <span class="o">|&gt;</span> <span class="nf">distinct</span><span class="p">(</span><span class="o">!!</span><span class="nf">as.name</span><span class="p">(</span><span class="n">columns[1L]</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">diamonds</span> <span class="o">|&gt;</span> <span class="nf">distinct</span><span class="p">(</span><span class="o">!!!</span><span class="n">rlang</span><span class="o">::</span><span class="nf">data_syms</span><span class="p">(</span><span class="n">columns</span><span class="p">))</span>
</span></span></code></pre></div><p>詳しくは <a href="https://rlang.r-lib.org/">rlangパッケージのドキュメント</a> か
<a href="https://amzn.to/3KpiXq0">宇宙船本</a>第3章のコラム
「selectのセマンティクスとmutateのセマンティクス」を参照。</p>
</dd>
<dt><code>dplyr::pull(.data, var = -1, name = NULL)</code></dt>
<dd>指定した1列をvector(またはlist)としてdata.frameから抜き出す。
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">diamonds</span> <span class="o">|&gt;</span> <span class="nf">head</span><span class="p">()</span> <span class="o">|&gt;</span> <span class="n">dplyr</span><span class="o">::</span><span class="nf">pull</span><span class="p">(</span><span class="n">price</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">diamonds</span> <span class="o">|&gt;</span> <span class="nf">head</span><span class="p">()</span> <span class="o">|&gt;</span> <span class="n">dplyr</span><span class="o">::</span><span class="nf">pull</span><span class="p">(</span><span class="s">&#34;price&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">diamonds</span> <span class="o">|&gt;</span> <span class="nf">head</span><span class="p">()</span> <span class="o">|&gt;</span> <span class="n">dplyr</span><span class="o">::</span><span class="nf">pull</span><span class="p">(</span><span class="m">7</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">diamonds</span> <span class="o">|&gt;</span> <span class="nf">head</span><span class="p">()</span> <span class="o">|&gt;</span> <span class="n">dplyr</span><span class="o">::</span><span class="nf">pull</span><span class="p">(</span><span class="m">-4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">diamonds</span> <span class="o">|&gt;</span> <span class="nf">head</span><span class="p">()</span> <span class="o">%&gt;%</span> <span class="nf">`[[`</span><span class="p">(</span><span class="s">&#34;price&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">diamonds</span> <span class="o">|&gt;</span> <span class="nf">head</span><span class="p">()</span> <span class="o">%&gt;%</span> <span class="p">{</span><span class="n">.[[</span><span class="s">&#34;price&#34;</span><span class="n">]]</span><span class="p">}</span>
</span></span></code></pre></div></dd>
<dd><code>name</code> オプションにID的な列を渡すと名前付きvectorを楽に作れる:
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">starwars</span> <span class="o">|&gt;</span> <span class="n">dplyr</span><span class="o">::</span><span class="nf">pull</span><span class="p">(</span><span class="n">mass</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
</span></span></code></pre></div></dd>
</dl>
<h3 id="行">行</h3>
<dl>
<dt><code>dplyr::filter(.data, ..., .by = NULL, .preserve = FALSE)</code></dt>
<dd>条件を満たす行だけを返す。<code>base::subset()</code> と似たようなもの。
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">diamonds</span> <span class="o">|&gt;</span> <span class="n">dplyr</span><span class="o">::</span><span class="nf">filter</span><span class="p">(</span><span class="n">carat</span> <span class="o">&gt;</span> <span class="m">3</span> <span class="o">&amp;</span> <span class="n">price</span> <span class="o">&lt;</span> <span class="m">10000</span><span class="p">)</span>
</span></span></code></pre></div><pre tabindex="0"><code>  carat     cut color clarity depth table price    x    y    z
1  3.01 Premium     I      I1  62.7    58  8040 9.10 8.97 5.67
2  3.11    Fair     J      I1  65.9    57  9823 9.15 9.02 5.98
3  3.01 Premium     F      I1  62.2    56  9925 9.24 9.13 5.73
</code></pre><p>評価結果が <code>NA</code> となる行は除去される。
特に不等号を使うときやや直感に反するので要注意。
e.g., <code>filter(gene != &quot;TP53&quot;)</code></p>
</dd>
<dd>
<p>複数列で条件指定するには <code>if_any()</code>, <code>if_all()</code> が使える。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">diamonds</span> <span class="o">|&gt;</span> <span class="n">dplyr</span><span class="o">::</span><span class="nf">filter</span><span class="p">(</span><span class="nf">if_any</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">),</span> <span class="nf">\</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="m">20</span><span class="p">))</span>
</span></span></code></pre></div><pre tabindex="0"><code>  carat       cut color clarity depth table price    x     y     z
1  2.00   Premium     H     SI2  58.9  57.0 12210 8.09 58.90  8.06
2  0.51 Very Good     E     VS1  61.8  54.7  1970 5.12  5.15 31.80
3  0.51     Ideal     E     VS1  61.8  55.0  2075 5.15 31.80  5.12
</code></pre><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">diamonds</span> <span class="o">|&gt;</span> <span class="n">dplyr</span><span class="o">::</span><span class="nf">filter</span><span class="p">(</span><span class="nf">if_all</span><span class="p">(</span><span class="nf">where</span><span class="p">(</span><span class="n">is.numeric</span><span class="p">),</span> <span class="nf">\</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="m">4.1</span><span class="p">))</span>
</span></span></code></pre></div><pre tabindex="0"><code>  carat  cut color clarity depth table price     x     y    z
1  4.13 Fair     H      I1  64.8    61 17329 10.00  9.85 6.43
2  5.01 Fair     J      I1  65.5    59 18018 10.74 10.54 6.98
3  4.50 Fair     J      I1  65.8    58 18531 10.23 10.16 6.72
</code></pre></dd>
<dt><code>dplyr::distinct(.data, ..., .keep_all = FALSE)</code></dt>
<dd>指定した列に関してユニークな行のみ返す。
<code>base::unique.data.frame()</code> よりも高速で、
<code>filter(!duplicated(.[, ...]))</code> よりスマートで柔軟。
指定しなかった列を残すには <code>.keep_all = TRUE</code> とする。
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">diamonds</span> <span class="o">|&gt;</span> <span class="n">dplyr</span><span class="o">::</span><span class="nf">distinct</span><span class="p">(</span><span class="n">cut</span><span class="p">)</span>
</span></span></code></pre></div><pre tabindex="0"><code>        cut
1     Ideal
2   Premium
3      Good
4 Very Good
5      Fair
</code></pre></dd>
<dt><code>dplyr::slice(.data, ..., .by = NULL, .preserve = FALSE)</code></dt>
<dd>行番号を指定して行を絞る。
<code>`[`(i,)</code> の代わりに。
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">diamonds</span> <span class="o">|&gt;</span> <span class="n">dplyr</span><span class="o">::</span><span class="nf">slice</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="m">2</span><span class="p">,</span> <span class="m">3</span><span class="p">)</span>
</span></span></code></pre></div><pre tabindex="0"><code>  carat     cut color clarity depth table price    x    y    z
1  0.23   Ideal     E     SI2  61.5    55   326 3.95 3.98 2.43
2  0.21 Premium     E     SI1  59.8    61   326 3.89 3.84 2.31
3  0.23    Good     E     VS1  56.9    65   327 4.05 4.07 2.31
</code></pre></dd>
<dt><code>dplyr::slice_head(.data, ..., n, prop)</code>, <code>slice_tail()</code></dt>
<dd>先頭・末尾の行を抽出。</dd>
<dt><code>dplyr::slice_max(.data, order_by, ..., n, prop, by = NULL, with_ties = TRUE, na_rm = FALSE)</code></dt>
<dd><code>order_by, ...</code> で指定した列の降順で <code>n</code> 行だけ返す。
境界のタイを保持する場合は <code>n</code> 行以上の出力になる。
昇順で取りたいときはマイナス指定か <code>slice_min()</code>。</dd>
<dt><code>dplyr::slice_sample(.data, ..., n, prop, weight_by = NULL, replace = FALSE)</code></dt>
<dd>指定した行数・割合だけランダムサンプルする。</dd>
</dl>
<h2 id="列の変更追加">列の変更・追加</h2>
<dl>
<dt><code>dplyr::mutate(.data, ..., .by = NULL, .keep = &quot;all&quot;, .before = NULL, .after = NULL)</code></dt>
<dd>新しい列を作ったり、既存の列を変更したり。
<code>base::transform()</code> の改良版。
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">diamonds</span> <span class="o">|&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="n">dplyr</span><span class="o">::</span><span class="nf">mutate</span><span class="p">(</span><span class="n">gram</span> <span class="o">=</span> <span class="m">0.2</span> <span class="o">*</span> <span class="n">carat</span><span class="p">)</span> <span class="o">|&gt;</span>  <span class="c1"># create new</span>
</span></span><span class="line"><span class="cl">  <span class="n">dplyr</span><span class="o">::</span><span class="nf">mutate</span><span class="p">(</span><span class="n">price</span> <span class="o">=</span> <span class="n">price</span> <span class="o">*</span> <span class="m">140</span><span class="p">)</span>    <span class="c1"># modify existing</span>
</span></span></code></pre></div><pre tabindex="0"><code>      carat     cut color clarity depth table  price    x    y    z  gram
    1  0.23   Ideal     E     SI2  61.5    55  45640 3.95 3.98 2.43 0.046
    2  0.21 Premium     E     SI1  59.8    61  45640 3.89 3.84 2.31 0.042
   --                                                                    
53939  0.86 Premium     H     SI2  61.0    58 385980 6.15 6.12 3.74 0.172
53940  0.75   Ideal     D     SI2  62.2    55 385980 5.83 5.87 3.64 0.150
</code></pre></dd>
<dd>変数に入った文字列を列名として使いたい場合は上記 <code>select()</code> のときと同様、
{{embrace}} や !!unquote を使う。
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">A</span> <span class="o">=</span> <span class="s">&#34;carat&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">B</span> <span class="o">=</span> <span class="s">&#34;gram&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">diamonds</span> <span class="o">|&gt;</span> <span class="n">dplyr</span><span class="o">::</span><span class="nf">mutate</span><span class="p">(</span><span class="n">B</span> <span class="o">=</span> <span class="m">0.2</span> <span class="o">*</span> <span class="o">!!</span><span class="nf">as.name</span><span class="p">(</span><span class="n">A</span><span class="p">))</span>
</span></span></code></pre></div><pre tabindex="0"><code>      carat     cut color clarity depth table price    x    y    z     B
    1  0.23   Ideal     E     SI2  61.5    55   326 3.95 3.98 2.43 0.046
    2  0.21 Premium     E     SI1  59.8    61   326 3.89 3.84 2.31 0.042
   --                                                                   
53939  0.86 Premium     H     SI2  61.0    58  2757 6.15 6.12 3.74 0.172
53940  0.75   Ideal     D     SI2  62.2    55  2757 5.83 5.87 3.64 0.150
</code></pre></dd>
<dd>左辺(代入先)の名前も文字列を使って表現したい場合は
<a href="https://www.tidyverse.org/blog/2020/02/glue-strings-and-tidy-eval/#custom-result-names">walrus(セイウチ)演算子 <code>:=</code></a>
を使う:
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">diamonds</span> <span class="o">|&gt;</span> <span class="n">dplyr</span><span class="o">::</span><span class="nf">mutate</span><span class="p">({{</span><span class="n">B</span><span class="p">}}</span> <span class="o">:=</span> <span class="m">0.2</span> <span class="o">*</span> <span class="o">!!</span><span class="nf">as.name</span><span class="p">(</span><span class="n">A</span><span class="p">))</span>
</span></span></code></pre></div><pre tabindex="0"><code>      carat     cut color clarity depth table price    x    y    z  gram
    1  0.23   Ideal     E     SI2  61.5    55   326 3.95 3.98 2.43 0.046
    2  0.21 Premium     E     SI1  59.8    61   326 3.89 3.84 2.31 0.042
   --                                                                   
53939  0.86 Premium     H     SI2  61.0    58  2757 6.15 6.12 3.74 0.172
53940  0.75   Ideal     D     SI2  62.2    55  2757 5.83 5.87 3.64 0.150
</code></pre></dd>
<dd><ul>
<li><code>.keep = &quot;all&quot;</code>: すべての列を残すデフォルト。</li>
<li><code>.keep = &quot;used&quot;</code>: 入力に使った列と出力の列のみ残す。</li>
<li><code>.keep = &quot;unused&quot;</code>: 入力に使った列は捨て、出力の列とほかの列を残す。</li>
<li><code>.keep = &quot;none&quot;</code>: グループ化と出力の列のみ残す。旧 <code>transmute()</code> のような挙動。</li>
</ul>
</dd>
<dd>新しい列をどこに作るかを <code>.before</code>, <code>.after</code> 指定できる。</dd>
<dd>
<p>複数の列をtidyselectして1列作りたいときは
<code>dplyr::pick(...)</code> と <code>Reduce(f, x)</code> / <code>purrr::reduce(.x, .f)</code> を組み合わせる:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">diamonds</span> <span class="o">|&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="n">dplyr</span><span class="o">::</span><span class="nf">mutate</span><span class="p">(</span><span class="n">prod</span> <span class="o">=</span> <span class="nf">Reduce</span><span class="p">(</span><span class="n">`*`</span><span class="p">,</span> <span class="nf">pick</span><span class="p">(</span><span class="nf">where</span><span class="p">(</span><span class="n">is.numeric</span><span class="p">))))</span> <span class="o">|&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="n">dplyr</span><span class="o">::</span><span class="nf">mutate</span><span class="p">(</span><span class="n">mean_xyz</span> <span class="o">=</span> <span class="nf">Reduce</span><span class="p">(</span><span class="n">`+`</span><span class="p">,</span> <span class="nf">pick</span><span class="p">(</span><span class="n">x</span><span class="o">:</span><span class="n">z</span><span class="p">))</span> <span class="o">/</span> <span class="nf">ncol</span><span class="p">(</span><span class="nf">pick</span><span class="p">(</span><span class="n">x</span><span class="o">:</span><span class="n">z</span><span class="p">)))</span> <span class="o">|&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="n">dplyr</span><span class="o">::</span><span class="nf">mutate</span><span class="p">(</span><span class="n">max_xyz</span> <span class="o">=</span> <span class="nf">Reduce</span><span class="p">(</span><span class="n">pmax</span><span class="p">,</span> <span class="nf">pick</span><span class="p">(</span><span class="n">x</span><span class="o">:</span><span class="n">z</span><span class="p">)))</span> <span class="o">|&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">print</span><span class="p">()</span>
</span></span></code></pre></div><p><code>dplyr::select()</code> と違って <code>.data</code> を渡さなくてもいいので、
プレースホルダの貧弱な base pipe <code>|&gt;</code> でも使える。</p>
</dd>
<dt><code>dplyr::rename(.data, ...)</code></dt>
<dd>列の改名。
<code>mutate()</code>と同じようなイメージで <code>new = old</code> と指定。
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">diamonds</span> <span class="o">|&gt;</span> <span class="n">dplyr</span><span class="o">::</span><span class="nf">rename</span><span class="p">(</span><span class="n">SIZE</span> <span class="o">=</span> <span class="n">carat</span><span class="p">)</span>
</span></span></code></pre></div><pre tabindex="0"><code>      SIZE     cut color clarity depth table price    x    y    z
    1 0.23   Ideal     E     SI2  61.5    55   326 3.95 3.98 2.43
    2 0.21 Premium     E     SI1  59.8    61   326 3.89 3.84 2.31
   --                                                            
53939 0.86 Premium     H     SI2  61.0    58  2757 6.15 6.12 3.74
53940 0.75   Ideal     D     SI2  62.2    55  2757 5.83 5.87 3.64
</code></pre></dd>
<dd>変数に入った文字列を使う場合も<code>mutate()</code>と同様に {{embrace}} や !!unquote で:
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">old_name</span> <span class="o">=</span> <span class="s">&#34;carat&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">new_name</span> <span class="o">=</span> <span class="nf">toupper</span><span class="p">(</span><span class="n">old_name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">diamonds</span> <span class="o">|&gt;</span> <span class="n">dplyr</span><span class="o">::</span><span class="nf">rename</span><span class="p">({{</span><span class="n">new_name</span><span class="p">}}</span> <span class="o">:=</span> <span class="p">{{</span><span class="n">old_name</span><span class="p">}})</span>
</span></span></code></pre></div><pre tabindex="0"><code>      CARAT     cut color clarity depth table price    x    y    z
    1  0.23   Ideal     E     SI2  61.5    55   326 3.95 3.98 2.43
    2  0.21 Premium     E     SI1  59.8    61   326 3.89 3.84 2.31
   --                                                             
53939  0.86 Premium     H     SI2  61.0    58  2757 6.15 6.12 3.74
53940  0.75   Ideal     D     SI2  62.2    55  2757 5.83 5.87 3.64
</code></pre><p>名前付きベクターと
<a href="https://rlang.r-lib.org/reference/splice-operator.html">!!!unquote-splicing</a>
を使えば一括指定できる:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">named_vec</span> <span class="o">=</span> <span class="nf">setNames</span><span class="p">(</span><span class="nf">names</span><span class="p">(</span><span class="n">diamonds</span><span class="p">),</span> <span class="kc">LETTERS</span><span class="nf">[seq</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="m">10</span><span class="p">)</span><span class="n">]</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">diamonds</span> <span class="o">|&gt;</span> <span class="n">dplyr</span><span class="o">::</span><span class="nf">rename</span><span class="p">(</span><span class="o">!!!</span><span class="n">named_vec</span><span class="p">)</span>
</span></span></code></pre></div><pre tabindex="0"><code>         A       B C   D    E  F    G    H    I    J
    1 0.23   Ideal E SI2 61.5 55  326 3.95 3.98 2.43
    2 0.21 Premium E SI1 59.8 61  326 3.89 3.84 2.31
   --                                               
53939 0.86 Premium H SI2 61.0 58 2757 6.15 6.12 3.74
53940 0.75   Ideal D SI2 62.2 55 2757 5.83 5.87 3.64
</code></pre></dd>
<dd><code>rename_with(.tbl, .fn, .cols = everything(), ...)</code>
はリネーム関数を渡せる亜種:
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">diamonds</span> <span class="o">|&gt;</span> <span class="n">dplyr</span><span class="o">::</span><span class="nf">rename_with</span><span class="p">(</span><span class="n">toupper</span><span class="p">,</span> <span class="nf">everything</span><span class="p">())</span>
</span></span></code></pre></div></dd>
</dl>
<h2 id="dataframeの要約集計整列">data.frameの要約・集計・整列</h2>
<dl>
<dt><code>dplyr::summarize(.data, ..., .by = NULL, .group = NULL)</code></dt>
<dd>指定した列に関数を適用して1行のdata.frameにまとめる。
グループ化されていたらグループごとに適用して <code>bind_rows()</code> する。
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">diamonds</span> <span class="o">|&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">group_by</span><span class="p">(</span><span class="n">cut</span><span class="p">)</span> <span class="o">|&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="nf">summarize</span><span class="p">(</span><span class="n">avg_carat</span> <span class="o">=</span> <span class="nf">mean</span><span class="p">(</span><span class="n">carat</span><span class="p">),</span> <span class="n">max_price</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="n">price</span><span class="p">))</span>
</span></span></code></pre></div><pre tabindex="0"><code>        cut avg_carat max_price
1      Fair 1.0461366     18574
2      Good 0.8491847     18788
3 Very Good 0.8063814     18818
4   Premium 0.8919549     18823
5     Ideal 0.7028370     18806
</code></pre></dd>
<dd>
<p>複数カラムに関数を適用するには <code>across()</code> を使う:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="c1"># summarize_at</span>
</span></span><span class="line"><span class="cl"><span class="n">diamonds</span> <span class="o">|&gt;</span> <span class="nf">summarize</span><span class="p">(</span><span class="nf">across</span><span class="p">(</span><span class="nf">starts_with</span><span class="p">(</span><span class="s">&#34;c&#34;</span><span class="p">),</span> <span class="n">max</span><span class="p">),</span> <span class="n">.by</span> <span class="o">=</span> <span class="n">cut</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># summarize_if</span>
</span></span><span class="line"><span class="cl"><span class="n">diamonds</span> <span class="o">|&gt;</span> <span class="nf">summarize</span><span class="p">(</span><span class="nf">across</span><span class="p">(</span><span class="nf">where</span><span class="p">(</span><span class="n">is.numeric</span><span class="p">),</span> <span class="n">max</span><span class="p">),</span> <span class="n">.by</span> <span class="o">=</span> <span class="n">cut</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># summarize_all</span>
</span></span><span class="line"><span class="cl"><span class="n">diamonds</span> <span class="o">|&gt;</span> <span class="nf">summarize</span><span class="p">(</span><span class="nf">across</span><span class="p">(</span><span class="nf">everything</span><span class="p">(),</span> <span class="n">max</span><span class="p">),</span> <span class="n">.by</span> <span class="o">=</span> <span class="n">cut</span><span class="p">)</span>
</span></span></code></pre></div></dd>
<dd>
<p>各列の計算結果は長さ1でなければいけない。
そうじゃなくても大丈夫な時期もあったが、その機能は <code>reframe()</code> に分離された。</p>
</dd>
<dt><code>dplyr::reframe(.data, ..., .by = NULL, .group = NULL)</code></dt>
<dd>各グループの結果が複数行にまたがっても大丈夫な <code>summarize()</code> 亜種。
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">diamonds</span> <span class="o">|&gt;</span> <span class="n">dplyr</span><span class="o">::</span><span class="nf">reframe</span><span class="p">(</span><span class="nf">range</span><span class="p">(</span><span class="n">carat</span><span class="p">),</span> <span class="nf">range</span><span class="p">(</span><span class="n">price</span><span class="p">))</span>
</span></span></code></pre></div><pre tabindex="0"><code>  range(carat) range(price)
1         0.20          326
2         5.01        18823
</code></pre></dd>
<dd>
<p>各グループの結果がtibbleの場合、結合・展開してくれる:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">diamonds</span> <span class="o">|&gt;</span> <span class="n">dplyr</span><span class="o">::</span><span class="nf">nest_by</span><span class="p">(</span><span class="n">cut</span><span class="p">)</span> <span class="o">|&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="n">dplyr</span><span class="o">::</span><span class="nf">reframe</span><span class="p">(</span><span class="nf">head</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="m">2L</span><span class="p">))</span>
</span></span></code></pre></div><p>これを利用して複数ファイルを一気読みできる:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">path</span> <span class="o">=</span> <span class="n">fs</span><span class="o">::</span><span class="nf">dir_ls</span><span class="p">(</span><span class="s">&#34;path/to/data&#34;</span><span class="p">,</span> <span class="n">glob</span> <span class="o">=</span> <span class="s">&#34;*.tsv&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span> <span class="o">=</span> <span class="nf">tibble</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">|&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="n">dplyr</span><span class="o">::</span><span class="nf">rowwise</span><span class="p">()</span> <span class="o">|&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="n">dplyr</span><span class="o">::</span><span class="nf">reframe</span><span class="p">(</span><span class="n">readr</span><span class="o">::</span><span class="nf">read_tsv</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
</span></span></code></pre></div><p>けどまあ <code>purrr::map(path, read_tsv) |&gt; purrr::list_rbind()</code>
のほうが読みやすい気がする。</p>
</dd>
<dt><code>dplyr::tally(x, wt, sort = FALSE)</code></dt>
<dd><code>summarize(x, n = n())</code> のショートカット。
<code>wt</code> にカラムを指定して重み付けすることもできる。</dd>
<dd><code>dplyr::add_tally()</code> は元の形を維持したままカウント列を追加。</dd>
<dt><code>dplyr::count(x, ..., wt = NULL, sort = FALSE)</code></dt>
<dd><code>group_by(...) |&gt; tally()</code> のショートカット。</dd>
<dd><code>dplyr::add_count()</code> は元の形を維持したままカウント列を追加。</dd>
<dt><code>dplyr::arrange(.data, ..., .by_group = FALSE)</code></dt>
<dd>指定した列の昇順でdata.frameの行を並べ替える。
<code>arrange(desc(column))</code> で降順になる。
<code>order()</code> を使うよりもタイピングの繰り返しが少ないし直感的
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">mtcars</span><span class="nf">[order</span><span class="p">(</span><span class="n">mtcars</span><span class="o">$</span><span class="n">cyl</span><span class="p">,</span> <span class="n">mtcars</span><span class="o">$</span><span class="n">disp</span><span class="p">),</span> <span class="n">]</span>
</span></span><span class="line"><span class="cl"><span class="c1"># is equivalent to</span>
</span></span><span class="line"><span class="cl"><span class="n">mtcars</span> <span class="o">|&gt;</span> <span class="n">dplyr</span><span class="o">::</span><span class="nf">arrange</span><span class="p">(</span><span class="n">cyl</span><span class="p">,</span> <span class="n">disp</span><span class="p">)</span>
</span></span></code></pre></div></dd>
<dt><code>dplyr::relocate(.data, ..., .before = NULL, .after = NULL)</code></dt>
<dd>指定した列を左端(もしくは <code>.before</code>/<code>.after</code> 別の列)に移動する。</dd>
</dl>
<h2 id="dataframeを結合">data.frameを結合</h2>
<dl>
<dt><code>dplyr::***_join(x, y, by = NULL, copy = FALSE)</code></dt>
<dd><code>by</code> で指定した列がマッチするように行を合わせて <code>cbind()</code>
<p><code>full_join()</code>: <code>x</code> と <code>y</code> の全ての行を保持。<br>
<code>inner_join()</code>: <code>x</code> と <code>y</code> の <code>by</code> がマッチする行のみ<br>
<code>left_join()</code>: <code>x</code> の全ての行を保持。<code>y</code> に複数マッチする行があったらすべて保持。<br>
<code>right_join()</code>: <code>y</code> の全ての行を保持。<code>x</code> に複数マッチする行があったらすべて保持。<br>
<code>semi_join()</code>: <code>x</code> の全ての行を保持。<code>y</code> に複数マッチする行があっても元の <code>x</code> の行だけ保持。<br>
<code>anti_join()</code>: <code>y</code> にマッチしない <code>x</code> の行のみ。<br>
<code>cross_join()</code>: マッチするものではなく、全ての組み合わせを作って結合。</p>
</dd>
<dd>
<p>列名が異なる場合は <code>by</code> を名前付きvectorにする:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">dplyr</span><span class="o">::</span><span class="nf">full_join</span><span class="p">(</span><span class="n">band_members</span><span class="p">,</span> <span class="n">band_instruments2</span><span class="p">,</span> <span class="n">by</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#34;artist&#34;</span><span class="p">))</span>
</span></span></code></pre></div></dd>
<dd><a href="https://dplyr.tidyverse.org/reference/join_by.html"><code>join_by()</code></a>
を使えば不等号などを含めて柔軟に結合条件を指定できる。</dd>
<dt><code>dplyr::bind_rows(...)</code>, <code>dplyr::bind_cols(...)</code></dt>
<dd>標準の <code>rbind()</code>, <code>cbind()</code> より効率よくdata.frameを結合。
引数は個別でもリストでもよい。
そのほかにも標準の集合関数を置き換えるものが提供されている:
<code>intersect()</code>, <code>union()</code>, <code>union_all()</code>, <code>setdiff()</code>, <code>setequal()</code></dd>
</dl>
<h2 id="その他の関数">その他の関数</h2>
<p>主に<code>mutate()</code>や<code>filter()</code>を補助するもの</p>
<dl>
<dt><code>dplyr::if_else(condition, true, false, missing = NULL, ..., ptype = NULL, size = NULL)</code></dt>
<dd><code>TRUE</code> の位置では <code>x</code> を採用、<code>FALSE</code> の位置では <code>y</code> を採用。
標準の<code>ifelse()</code>よりも型に厳しく、高速らしい。
NAのときにどうするかを指定できるのも大変良い。
ネストせずにスッキリ書ける <code>dplyr::case_when()</code> も便利。
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">condition</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="kc">TRUE</span><span class="p">,</span> <span class="kc">TRUE</span><span class="p">,</span> <span class="kc">FALSE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">x</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="m">2</span><span class="p">,</span> <span class="m">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">y</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="m">100</span><span class="p">,</span> <span class="m">200</span><span class="p">,</span> <span class="m">300</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">dplyr</span><span class="o">::</span><span class="nf">if_else</span><span class="p">(</span><span class="n">condition</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</span></span></code></pre></div><pre tabindex="0"><code>[1]   1   2 300
</code></pre></dd>
<dt><code>dplyr::coalesce(..., .ptype = NULL, .size = NULL)</code></dt>
<dd>最初のvectorでNAだったとこは次のvectorのやつを採用、
という<code>ifelse(!is.na(x), x, y)</code>的な処理をする。
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">df</span> <span class="o">=</span> <span class="n">tibble</span><span class="o">::</span><span class="nf">tibble</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="m">2</span><span class="p">,</span> <span class="kc">NA</span><span class="p">),</span> <span class="n">y</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="s">&#34;a&#34;</span><span class="p">,</span> <span class="kc">NA</span><span class="p">,</span> <span class="s">&#34;c&#34;</span><span class="p">),</span> <span class="n">z</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="s">&#34;D&#34;</span><span class="p">,</span> <span class="s">&#34;E&#34;</span><span class="p">,</span> <span class="kc">NA</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span> <span class="o">|&gt;</span> <span class="n">dplyr</span><span class="o">::</span><span class="nf">mutate</span><span class="p">(</span><span class="n">y_or_z</span> <span class="o">=</span> <span class="n">dplyr</span><span class="o">::</span><span class="nf">coalesce</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">))</span>
</span></span></code></pre></div><pre tabindex="0"><code>   x    y    z y_or_z
1  1    a    D      a
2  2 &lt;NA&gt;    E      E
3 NA    c &lt;NA&gt;      c
</code></pre><p>基本的には同じ長さのvectorを渡すが、
2つめに長さ1のを渡して<code>tidyr::replace_na()</code>的に使うのも便利。</p>
</dd>
<dt><code>dplyr::na_if(x, y)</code></dt>
<dd><code>x[x == y] = NA; x</code> のショートカット
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">df</span> <span class="o">|&gt;</span> <span class="n">dplyr</span><span class="o">::</span><span class="nf">mutate</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">dplyr</span><span class="o">::</span><span class="nf">na_if</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="m">1</span><span class="p">),</span> <span class="n">y</span> <span class="o">=</span> <span class="n">dplyr</span><span class="o">::</span><span class="nf">na_if</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="s">&#34;a&#34;</span><span class="p">))</span>
</span></span></code></pre></div><pre tabindex="0"><code>   x    y    z
1 NA &lt;NA&gt;    D
2  2 &lt;NA&gt;    E
3 NA    c &lt;NA&gt;
</code></pre></dd>
<dt><code>dplyr::recode(.x, ..., .default = NULL, .missing = NULL)</code></dt>
<dd>vectorの値を変更する。e.g.,
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="nf">recode</span><span class="p">(</span><span class="kc">letters</span><span class="n">[1</span><span class="o">:</span><span class="m">6</span><span class="n">]</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="s">&#34;A!&#34;</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="s">&#34;C!&#34;</span><span class="p">)</span>
</span></span></code></pre></div><pre tabindex="0"><code>[1] &#34;A!&#34; &#34;b&#34;  &#34;C!&#34; &#34;d&#34;  &#34;e&#34;  &#34;f&#34; 
</code></pre></dd>
<dt><code>dplyr::row_number(x)</code></dt>
<dd><code>rank(x, ties.method = &quot;first&quot;, na.last = &quot;keep&quot;)</code> のショートカット。
グループ毎に連番を振るのに便利。同点でも登場順に違う順位を与える。</dd>
<dd><code>dplyr::min_rank(x)</code>: 同点には同じ値。2位タイがあれば3位不在。<code>ties.method = &quot;min&quot;</code></dd>
<dd><code>dplyr::dense_rank(x)</code>: 同点には同じ値。2位タイがあっても3位から再スタート。</dd>
<dt><code>dplyr::consecutive_id(...)</code></dt>
<dd>値が変化したら番号をインクリメント。こういうグループ化したいときがある:
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="nf">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">1</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="n">dplyr</span><span class="o">::</span><span class="nf">consecutive_id</span><span class="p">()</span>
</span></span></code></pre></div><pre tabindex="0"><code>[1] 1 1 2 2 2 3 3 4
</code></pre></dd>
<dt><code>dplyr::ntile(x, n)</code></dt>
<dd>数値ベクトル <code>x</code> を順位によって <code>n</code> 個のクラスに均等分け</dd>
<dt><code>dplyr::n_distinct(x)</code></dt>
<dd>高速で簡潔な <code>length(unique(x))</code></dd>
<dt><code>dplyr::n_groups(x)</code></dt>
<dd>グループ数。</dd>
<dt><code>dplyr::last(x, order_by = NULL, default = default_missing(x))</code></dt>
<dd>最後の要素にアクセス。
<code>x[length(x)]</code> や <code>tail(x, 1)</code> よりも楽チンだが、
安全性重視の <code>dplyr::nth()</code> を内部で呼び出すため遅い。</dd>
<dt><code>dplyr::lead(x n = 1, default = NA, order_by = NULL)</code>, <code>dplyr::lag(...)</code></dt>
<dd><code>x</code> の中身を <code>n</code> だけずらして <code>default</code> で埋める。
<code>lead()</code> は前に、<code>lag()</code> は後ろにずらす
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="nf">lag</span><span class="p">(</span><span class="nf">seq_len</span><span class="p">(</span><span class="m">5</span><span class="p">),</span> <span class="m">2</span><span class="p">)</span>
</span></span></code></pre></div><pre tabindex="0"><code>[1] NA NA  1  2  3
</code></pre><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="c1">## [1] NA NA 1 2 3</span>
</span></span></code></pre></div></dd>
<dt><code>dplyr::between(x, left, right)</code></dt>
<dd><code>left &lt;= x &amp; x &lt;= right</code> のショートカット。</dd>
<dt><code>dplyr::near(x, y, tol = .Machine$double.eps^0.5)</code></dt>
<dd><code>abs(x - y) &lt; tol</code> のショートカット。</dd>
<dt><code>dplyr::case_when(...)</code></dt>
<dd><code>if {} else if {} else if {} ...</code> のショートカット。</dd>
</dl>
<h2 id="グループ化">グループ化</h2>
<p><a href="/rstats/tidyr.html"><code>tidyr</code></a> でネストして、
<a href="/rstats/purrr.html"><code>purrr</code></a> でその list of data.frames に処理を施し、
<a href="/rstats/dplyr.html"><code>dplyr</code></a> でその変更を元の data.frame に適用する、
というのがtidyverse流の柔軟なやり方。</p>
<p>v0.8.1で <code>group_modify()</code> などが導入され、
ネストせずグループ化までで済ませやすくなった。</p>
<p>v1.1.0 からは多くの関数に一時グループ化
<a href="https://dplyr.tidyverse.org/reference/dplyr_by.html"><code>.by</code> / <code>by</code></a>
オプションが追加され、
事前のグループ化と事後のグループ解除を省略しやすくなった。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">diamonds</span> <span class="o">|&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="n">dplyr</span><span class="o">::</span><span class="nf">group_nest</span><span class="p">(</span><span class="n">cut</span><span class="p">)</span> <span class="o">|&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="n">dplyr</span><span class="o">::</span><span class="nf">mutate</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">purrr</span><span class="o">::</span><span class="nf">map</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nf">\</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="nf">head</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="m">2L</span><span class="p">)))</span> <span class="o">|&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="n">tidyr</span><span class="o">::</span><span class="nf">unnest</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># dplyr &gt;= 0.8.1</span>
</span></span><span class="line"><span class="cl"><span class="n">diamonds</span> <span class="o">|&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="n">dplyr</span><span class="o">::</span><span class="nf">group_by</span><span class="p">(</span><span class="n">cut</span><span class="p">)</span> <span class="o">|&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="n">dplyr</span><span class="o">::</span><span class="nf">group_modify</span><span class="p">(</span><span class="nf">\</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span> <span class="nf">head</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="m">2L</span><span class="p">))</span> <span class="o">|&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="n">dplyr</span><span class="o">::</span><span class="nf">ungroup</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># dplyr &gt;= 1.1.0</span>
</span></span><span class="line"><span class="cl"><span class="n">diamonds</span> <span class="o">|&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="n">dplyr</span><span class="o">::</span><span class="nf">slice_head</span><span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="m">2L</span><span class="p">,</span> <span class="n">by</span> <span class="o">=</span> <span class="n">cut</span><span class="p">)</span>
</span></span></code></pre></div><dl>
<dt><code>dplyr::group_by(.data, ..., add = FALSE, .drop = group_by_drop_default(.data))</code></dt>
<dd>グループごとに区切って次の処理に渡す。
e.g. <code>summarize()</code>, <code>slice()</code>, <code>tally()</code>, <code>group_modify()</code> など</dd>
<dd><code>.drop = FALSE</code> とすると行数ゼロになるグループも捨てずに保持できる。</dd>
<dt><code>dplyr::group_data(.data)</code></dt>
<dd>グループ情報を参照:
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">diamonds</span> <span class="o">|&gt;</span> <span class="n">dplyr</span><span class="o">::</span><span class="nf">group_by</span><span class="p">(</span><span class="n">cut</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="n">dplyr</span><span class="o">::</span><span class="nf">group_data</span><span class="p">()</span>
</span></span></code></pre></div><pre tabindex="0"><code>        cut         .rows
1      Fair  &lt;int [1610]&gt;
2      Good  &lt;int [4906]&gt;
3 Very Good &lt;int [12082]&gt;
4   Premium &lt;int [13791]&gt;
5     Ideal &lt;int [21551]&gt;
</code></pre><p>左側のキー列だけ欲しければ <code>dplyr::group_keys()</code> 、<br>
左端の行番号だけ欲しければ <code>dplyr::group_rows()</code> 。</p>
</dd>
<dt><code>dplyr::group_nest(.tbl, ..., .key = &quot;data&quot;, keep = FALSE)</code></dt>
<dd>入れ子 data.frame を作る。
<code>tidyr::nest(.by = c(...))</code> と役割が被りすぎて微妙な立場らしい。</dd>
<dd><code>keep = TRUE</code> とするとグループ化に使った列も入れ子のdata.frameに残す。</dd>
<dd>グループ化を解除してフラットな <code>tbl_df</code> を返す。</dd>
<dt><code>dplyr::nest_by(.tbl, ..., .key = &quot;data&quot;, keep = FALSE)</code></dt>
<dd>上記 <code>group_nest</code> とほぼ同じだが、こちらはグループ化されたまま <code>rowwise_df</code> を返す。</dd>
<dt><code>dplyr::group_split(.tbl, ..., .key = &quot;data&quot;, .keep = FALSE)</code></dt>
<dd>list of data.frames に分割する。
<code>.tbl |&gt; split(.$group)</code> と同等だが、
ドットダラーを使わくて済むし複数列をキーにするのも簡単。</dd>
<dt><code>dplyr::group_indices(.data, ...)</code></dt>
<dd><code>grouped_df</code> ではなくグループIDとして1からの整数列を返す版 <code>group_by()</code></dd>
<dt><code>dplyr::group_modify(.tbl, .f, ..., .keep = FALSE)</code></dt>
<dd>グループごとに <code>.f</code> を適用して再結合したdata.frameを返す。</dd>
<dd><code>.f</code> は2つの引数をとる関数。
1つめは区切られたdata.frame、
2つめはグループ化のキー(となった列を含む1行のdata.frame)。
引数が1つだったり、違うものを2つめに受け取る関数はそのままじゃ渡せないので、
<a href="/rstats/purrr.html">purrr</a>のときと同様に無名関数に包んで渡す。
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">diamonds</span> <span class="o">|&gt;</span> <span class="n">dplyr</span><span class="o">::</span><span class="nf">group_by</span><span class="p">(</span><span class="n">cut</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="n">dplyr</span><span class="o">::</span><span class="nf">group_modify</span><span class="p">(</span><span class="nf">\</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span> <span class="nf">head</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="m">2L</span><span class="p">))</span>
</span></span></code></pre></div><pre tabindex="0"><code>       cut carat color clarity depth table price    x    y    z
 1    Fair  0.22     E     VS2  65.1    61   337 3.87 3.78 2.49
 2    Fair  0.86     E     SI2  55.1    69  2757 6.45 6.33 3.52
 3    Good  0.23     E     VS1  56.9    65   327 4.05 4.07 2.31
 4    Good  0.31     J     SI2  63.3    58   335 4.34 4.35 2.75
--                                                             
 7 Premium  0.21     E     SI1  59.8    61   326 3.89 3.84 2.31
 8 Premium  0.29     I     VS2  62.4    58   334 4.20 4.23 2.63
 9   Ideal  0.23     E     SI2  61.5    55   326 3.95 3.98 2.43
10   Ideal  0.23     J     VS1  62.8    56   340 3.93 3.90 2.46
</code></pre></dd>
<dd>
<p><code>group_map()</code> は結果を <code>bind_rows()</code> せずlistとして返す亜種。<br>
<code>group_walk()</code> は <code>.f</code> 適用前の <code>.tbl</code> を返す亜種。</p>
</dd>
<dt><code>dplyr::rowwise(data, ...)</code></dt>
<dd>受け取ったdataに <code>rowwise_df</code> クラスを付与して返す。
これは1行ごとにグループ化された <code>grouped_df</code> のようなもので、
mutate などを適用すると列全体ではなく1行ごとに関数に渡される。
一旦非推奨となったがv1.0.0で蘇った。</dd>
<dd>ループ処理が重いので、計算内容と行数のバランスに注意。
例えば <code>dplyr::c_across()</code> の併用で横方向の合計や平均を簡潔に書けるが、
ベクトル演算を使う場合に比べてかなり遅い。
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">diamonds</span> <span class="o">|&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="n">dplyr</span><span class="o">::</span><span class="nf">rowwise</span><span class="p">()</span> <span class="o">|&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="n">dplyr</span><span class="o">::</span><span class="nf">mutate</span><span class="p">(</span><span class="n">mean_xyz</span> <span class="o">=</span> <span class="nf">mean</span><span class="p">(</span><span class="nf">c_across</span><span class="p">(</span><span class="n">x</span><span class="o">:</span><span class="n">z</span><span class="p">)))</span>                       <span class="c1"># slow</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">diamonds</span> <span class="o">|&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="n">dplyr</span><span class="o">::</span><span class="nf">mutate</span><span class="p">(</span><span class="n">mean_xyz</span> <span class="o">=</span> <span class="nf">Reduce</span><span class="p">(</span><span class="n">`+`</span><span class="p">,</span> <span class="nf">pick</span><span class="p">(</span><span class="n">x</span><span class="o">:</span><span class="n">z</span><span class="p">))</span> <span class="o">/</span> <span class="nf">ncol</span><span class="p">(</span><span class="nf">pick</span><span class="p">(</span><span class="n">x</span><span class="o">:</span><span class="n">z</span><span class="p">)))</span>  <span class="c1"># fast</span>
</span></span></code></pre></div></dd>
</dl>
<h2 id="deprecatedsuperseded">deprecated/superseded</h2>
<dl>
<dt><code>dplyr::do(.data, ...)</code></dt>
<dd><code>reframe()</code>, <code>slice*()</code> などに取って代わられた。
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="n">diamonds</span> <span class="o">|&gt;</span> <span class="n">dplyr</span><span class="o">::</span><span class="nf">group_by</span><span class="p">(</span><span class="n">cut</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="n">dplyr</span><span class="o">::</span><span class="nf">do</span><span class="p">(</span><span class="nf">head</span><span class="p">(</span><span class="n">.,</span> <span class="m">2L</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="n">diamonds</span> <span class="o">|&gt;</span> <span class="n">dplyr</span><span class="o">::</span><span class="nf">slice_head</span><span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="m">2L</span><span class="p">,</span> <span class="n">by</span> <span class="o">=</span> <span class="n">cut</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">diamonds</span> <span class="o">|&gt;</span> <span class="n">dplyr</span><span class="o">::</span><span class="nf">reframe</span><span class="p">(</span><span class="nf">across</span><span class="p">(</span><span class="nf">everything</span><span class="p">(),</span> <span class="n">range</span><span class="p">),</span> <span class="n">.by</span> <span class="o">=</span> <span class="n">cut</span><span class="p">)</span>
</span></span></code></pre></div></dd>
<dt><code>dplyr::transmute(.data, ...)</code></dt>
<dd>指定した列以外を保持しない版 <code>mutate()</code> 。
言い換えると、列の中身の変更もできる版 <code>select()</code> 。</dd>
<dd><code>mutate(.keep = &quot;none&quot;)</code> に取って代わられた。</dd>
<dt><code>*_at()</code>, <code>*_if()</code>, <code>*_all()</code>, <code>*_each()</code></dt>
<dd>条件を満たす列・複数の列に関数を適用する <code>mutate()</code>, <code>summarize()</code> 亜種。
<code>across()</code> の登場により非推奨。</dd>
<dt><code>top_n()</code>, <code>top_frac()</code></dt>
<dd><code>slice_min()</code>, <code>slice_max()</code> に取って代わられた。</dd>
<dt><code>sample_n()</code>, <code>sample_frac()</code></dt>
<dd><code>slice_sample()</code> に取って代わられた。</dd>
</dl>
<h3 id="matrix-array">matrix, array</h3>
<p>data.frame を主眼とする dplyr では matrix や array を扱わない。
一時期存在していた <code>tbl_cube</code> 関連の機能は
<a href="https://github.com/hadley/cubelyr">cubelyr</a> に隔離された。</p>
<dl>
<dt><code>as.tbl_cube(x, dim_names, met_names, ...)</code></dt>
<dd>matrix/arrayからdata.frameの一歩手前に変換する。
<a href="https://github.com/hadley/reshape"><code>reshape2::melt</code></a> の改良版。
これの結果に <code>tibble::as_tibble()</code> を適用するとわかりやすい。</dd>
<dd>ただし <code>dimnames(x)</code> が空ではダメで、長さの正しい名前付きlistになっている必要がある。</dd>
</dl>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="line"><span class="cl"><span class="c1"># deprecated</span>
</span></span><span class="line"><span class="cl"><span class="n">iris3</span> <span class="o">|&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="n">reshape2</span><span class="o">::</span><span class="nf">melt</span><span class="p">()</span> <span class="o">|&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="n">tibble</span><span class="o">::</span><span class="nf">as_tibble</span><span class="p">()</span> <span class="o">|&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="n">dplyr</span><span class="o">::</span><span class="nf">rename</span><span class="p">(</span><span class="n">obs</span> <span class="o">=</span> <span class="n">Var1</span><span class="p">,</span> <span class="n">metrics</span> <span class="o">=</span> <span class="n">Var2</span><span class="p">,</span> <span class="n">species</span> <span class="o">=</span> <span class="n">Var3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># new</span>
</span></span><span class="line"><span class="cl"><span class="n">x</span> <span class="o">=</span> <span class="n">iris3</span>
</span></span><span class="line"><span class="cl"><span class="nf">dimnames</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="n">[[1L]]</span> <span class="o">=</span> <span class="nf">seq_len</span><span class="p">(</span><span class="nf">dim</span><span class="p">(</span><span class="n">iris3</span><span class="p">)</span><span class="n">[[1L]]</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nf">names</span><span class="p">(</span><span class="nf">dimnames</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="s">&#34;obs&#34;</span><span class="p">,</span> <span class="s">&#34;metrics&#34;</span><span class="p">,</span> <span class="s">&#34;species&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">cubelyr</span><span class="o">::</span><span class="nf">as.tbl_cube</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">met_name</span> <span class="o">=</span> <span class="s">&#34;value&#34;</span><span class="p">)</span> <span class="o">|&gt;</span> <span class="nf">as_tibble</span><span class="p">()</span>
</span></span></code></pre></div>
</article>
</main>

<nav class="side-bar">
<div class="menu">

<div><a href="/about.html">About</a></div>

<div><a href="/research.html">Research Interests</a></div>

<input type="checkbox" id="menu-rstats" checked>
<label for="menu-rstats" class="active">R stats</label>
<ul>
<li><a href="/rstats/intro.html">R自学自習の基礎知識</a></li>
<li><a href="/rstats/programming.html">RプログラミングTips</a></li>
<li><a href="/rstats/config.html">R環境設定</a></li>
<li><a href="/rstats/ggplot2.html">ggplot2</a></li>
<li class="active"><a href="/rstats/dplyr.html">dplyr</a></li>
<li><a href="/rstats/tidyr.html">tidyr</a></li>
<li><a href="/rstats/purrr.html">purrr</a></li>
<li><a href="/rstats/readr.html">readr</a></li>
<li><a href="/rstats/stringr.html">stringr</a></li>
<li><a href="/rstats/knitr.html">knitr</a></li>
<li><a href="/rstats/parallel.html">parallel</a></li>
<li><a href="/rstats/devtools.html">devtools</a></li>
<li><a href="/rstats/rcpp.html">Rcpp</a></li>
<li><a href="/rstats/bioconductor.html">Bioconductor</a></li>
<li><a href="/rstats/genomicranges.html">GenomicRanges</a></li>
<li><a href="/rstats/rtracklayer.html">rtracklayer</a></li>
<li><a href="/rstats/biomart.html">biomaRt</a></li>
<li><a href="/rstats/edger.html">edgeR</a></li>
<li><a href="/rstats/topgo.html">topGO</a></li>
<li><a href="/rstats/rgl.html">rgl</a></li>
<li><a href="/rstats/stan.html">Stan</a></li>
</ul>

<input type="checkbox" id="menu-python">
<label for="menu-python">Python</label>
<ul>
<li><a href="/python/install.html">Pythonインストール</a></li>
<li><a href="/python/pip.html">pip</a></li>
<li><a href="/python/ipython.html">IPython</a></li>
<li><a href="/python/biopython.html">BioPython</a></li>
<li><a href="/python/concurrent.html">concurrent.futures</a></li>
<li><a href="/python/copy.html">copy</a></li>
<li><a href="/python/matplotlib.html">matplotlib &#43; seaborn</a></li>
<li><a href="/python/scipy.html">NumPy, SciPy</a></li>
<li><a href="/python/pandas.html">Pandas</a></li>
<li><a href="/python/packaging.html">Pythonパッケージ作成</a></li>
</ul>

<input type="checkbox" id="menu-cxx">
<label for="menu-cxx">C&#43;&#43;</label>
<ul>
<li><a href="/cxx/boost.html">Boost</a></li>
<li><a href="/cxx/getopt.html">C&#43;&#43;コマンドライン引数</a></li>
<li><a href="/cxx/speed.html">C&#43;&#43;高速化</a></li>
<li><a href="/cxx/gcc.html">gcc</a></li>
<li><a href="/cxx/bitwise.html">ビット演算</a></li>
<li><a href="/cxx/random.html">擬似乱数生成器</a></li>
</ul>

<input type="checkbox" id="menu-bio">
<label for="menu-bio">Biology</label>
<ul>
<li><a href="/bio/blast.html">BLAST</a></li>
<li><a href="/bio/dadi.html">dadi</a></li>
<li><a href="/bio/gene_ontology.html">Gene Ontology</a></li>
<li><a href="/bio/meme.html">MEME</a></li>
<li><a href="/bio/popgen.html">Population Genetics</a></li>
<li><a href="/bio/repeatmasker.html">RepeatMasker</a></li>
<li><a href="/bio/samtools.html">SAMtools</a></li>
<li><a href="/bio/shirokane.html">SHIROKANE</a></li>
<li><a href="/bio/stochastic_process.html">Stochastic Process</a></li>
<li><a href="/bio/mathmorph.html">数理形態学</a></li>
<li><a href="/bio/linear_algebra.html">線形代数</a></li>
<li><a href="/bio/complexnetwork.html">複雑ネットワーク</a></li>
<li><a href="/bio/nig.html">遺伝研スパコン</a></li>
<li><a href="/bio/motif.html">配列モチーフ探索</a></li>
</ul>

<input type="checkbox" id="menu-dev">
<label for="menu-dev">Developer Tools</label>
<ul>
<li><a href="/dev/apptainer.html">Apptainer</a></li>
<li><a href="/dev/autotools.html">autoconf, automake</a></li>
<li><a href="/dev/cmake.html">CMake</a></li>
<li><a href="/dev/docker.html">Docker</a></li>
<li><a href="/dev/emacs.html">Emacs</a></li>
<li><a href="/dev/git.html">Git</a></li>
<li><a href="/dev/make.html">make</a></li>
<li><a href="/dev/mount.html">mount</a></li>
<li><a href="/dev/rsync.html">rsync</a></li>
<li><a href="/dev/ssh.html">ssh</a></li>
<li><a href="/dev/tmux.html">tmux</a></li>
<li><a href="/dev/torque.html">TORQUE</a></li>
<li><a href="/dev/vi.html">vi</a></li>
<li><a href="/dev/vscode.html">VSCode</a></li>
<li><a href="/dev/zsh.html">zsh</a></li>
<li><a href="/dev/sh.html">シェルスクリプト</a></li>
<li><a href="/dev/nohup.html">プロセス管理</a></li>
<li><a href="/dev/devenv.html">開発環境</a></li>
</ul>

<input type="checkbox" id="menu-mac">
<label for="menu-mac">Mac</label>
<ul>
<li><a href="/mac/applescript.html">AppleScript</a></li>
<li><a href="/mac/homebrew.html">Homebrew</a></li>
<li><a href="/mac/keyboard.html">Keyboard</a></li>
<li><a href="/mac/command.html">Mac固有コマンド</a></li>
<li><a href="/mac/quicklook.html">QuickLook</a></li>
<li><a href="/mac/winebottler.html">WineBottler</a></li>
</ul>

<input type="checkbox" id="menu-lectures">
<label for="menu-lectures">Lectures</label>
<ul>
<li><a href="/lectures/verhoef_comm_ecol-11.html">Community Ecology 輪読会 11章</a></li>
<li><a href="/lectures/git2018nrifs.html">Git入門2018</a></li>
<li><a href="/lectures/git2019makino.html">Git入門2019</a></li>
<li><a href="/lectures/prml-11-1.html">PRML輪読会 11章1節</a></li>
<li><a href="/lectures/prml-2-1.html">PRML輪読会 2章前半</a></li>
<li><a href="/lectures/prml-3-4.html">PRML輪読会 3章4節</a></li>
<li><a href="/lectures/wakeley-2-2.html">Wakeley輪読会 2章2節</a></li>
</ul>

<input type="checkbox" id="menu-misc">
<label for="menu-misc">Miscellaneous</label>
<ul>
<li><a href="/misc/fonts.html">Fonts</a></li>
<li><a href="/misc/gollum.html">Gollum</a></li>
<li><a href="/misc/hugo.html">Hugo</a></li>
<li><a href="/misc/latex.html">LaTeX</a></li>
<li><a href="/misc/markdown.html">Markdown</a></li>
</ul>

<div><a href="/tags/">Tags</a></div>
</div>
</nav>
<footer><small>(ɔ) 2008 岩嵜航 Watal M. Iwasaki</small></footer>
</body>
</html>
