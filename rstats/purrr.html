<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400italic,700,700italic%7CUbuntu+Mono:400,400italic,700,700italic">
<link rel="stylesheet" href="/css/theme.css">
<link rel="shortcut icon" href="/favicon.ico">
<link rel="icon" href="/favicon-192x192.png" sizes="192x192">
<link rel="apple-touch-icon" href="/favicon-192x192.png" sizes="192x192">
<title>purrr: ループ処理やapply系関数の決定版 - Heavy Watal</title>
<meta name="author" content="Watal M. Iwasaki">
<meta property="og:type" content="article">
<meta property="og:image" content="https://avatars.githubusercontent.com/heavywatal">
<meta name="generator" content="Hugo 0.19-DEV" />
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  displayAlign: "left",
  displayIndent: "2em",
  tex2jax: {
    inlineMath: [['$','$']],
    displayMath: [['$$','$$']],
    processEnvironments: false
  }
});
MathJax.Hub.Queue(function() {
  var all = MathJax.Hub.getAllJax(), i;
  for(i = 0; i < all.length; i += 1) {
    all[i].SourceElement().parentNode.classList.add('has-jax');
  }
});
</script>
<script async src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_CHTML"></script>

<script type="application/ld+json">{
"@context": "http://schema.org",
"@type": "BreadcrumbList",
"itemListElement": [
 {"@type": "ListItem",
  "position": 1,
  "item": {
   "@id": "https://heavywatal.github.io/rstats.html",
   "name": "rstats"}},
 {"@type": "ListItem",
  "position": 2,
  "item": {
   "@id": "https://heavywatal.github.io/rstats/purrr.html",
   "name": "purrr"}}
]}</script>


<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-41178626-2', 'auto');
ga('send', 'pageview');
</script>

</head>
<body>
<header><h1><a href="/">
<img class="logo" src="/favicon-192x192.png" alt="岩嵜航">
Heavy Watal
</a></h1>
<form class="cse-search-box" action="/search.html">
  <input type="text" name="q" required>
</form>
</header>

<main>
<article>
<header><h1><a href=".">
purrr — ループ処理やapply系関数の決定版
</a></h1>
<ul class="tags">
<li><a href="/tags/r">r</a></li>
<li><a href="/tags/tidyverse">tidyverse</a></li>
</ul>
</header>



<p>標準のapply族や<a href="/rstats/plyr.html">plyr</a>の関数に引導を渡すべく再設計されたようなパッケージ。
<a href="/rstats/dplyr.html">dplyr</a> や <a href="/rstats/tidyr.html">tidyr</a> と組み合わせて真価を発揮する。
purerのように読むらしい。
いまのところ並列化する機能はないので、そういうときは
<a href="/rstats/foreach.html">foreachとparallel</a> を使う。</p>

<p><a href="https://github.com/tidyverse/tidyverse">tidyverse</a> に含まれているので、
<code>install.packages('tidyverse')</code> で一括インストール、
<code>library(tidyverse)</code> で一括ロード。</p>

<p>パイプ演算子 <code>%&gt;%</code> については<a href="/rstats/dplyr.html">dplyr</a>を参照。</p>

<p><a href="https://github.com/hadley/purrr">https://github.com/hadley/purrr</a></p>

<h2 id="list-vector操作">list, vector操作</h2>

<dl>
<dt><code>purrr::map(.x, .f, ...)</code></dt>
<dd>listの各要素に関数を適用し、listで返す。
<code>base::lapply()</code>や<code>plyr::llply()</code>の改良版。
型の決まったvectorを返す<code>base::sapply()</code>や<code>base::vapply()</code>の改良版として
<code>map_lgl()</code>, <code>map_chr()</code>, <code>map_int()</code>, <code>map_dbl()</code> がある。</dd>
<dd><code>purrr::walk(.x, .f, ...)</code>は、
<code>map()</code>同様に関数を適用しつつ元の値をそのままinvisible返しする亜種。</dd>
<dd><code>purrr::lmap(.x, .f, ...)</code>は、
<code>.x[[i]]</code>ではなく<code>.x[i]</code>を参照する点で<code>map()</code>と異なる亜種。</dd>
<dt><code>purrr::map_df(.x, .f, ..., .id=NULL)</code></dt>
<dd>listの各要素に関数を適用し、結果を
<code>dplyr::bind_rows()</code>で結合したdata.frameとして返す。
<code>plyr::ldply()</code>の改良版として。</dd>
<dt><code>purrr::map2(.x, .y, .f, ...)</code></dt>
<dd>2変数バージョン。<code>map2_chr()</code>などの型限定vector版も提供されている。
3変数以上渡したいときはlistかdata.frameにまとめて下の<code>pmap()</code>を使う。</dd>
<dt><code>purrr::pmap(.l, .f, ...)</code></dt>
<dd>listの中身をparallelに処理するmap。
<code>.f</code>の引数はlistの要素名と一致させる。
e.g., <code>pmap(list(a=1:3, b=4:6), function(a, b) {a * b})</code> 。
名前無し2要素までなら<code>map2()</code>などと同様に<code>.x</code>や<code>.y</code>を使ったformulaが利用可能。
e.g., <code>pmap(list(1:3, 4:6), ~ .x * .y)</code> 。</dd>
<dd>data.frameの正体はlist of columnsなので、
そのまま<code>.l</code>として渡して<code>plyr::mlply()</code>的に使える。
同様に <code>purrr::pmap_df()</code> は <code>plyr::mdply()</code> として使える。</dd>
<dd><code>purrr::invoke_rows(.f, .d, ..., .collate, .to, .labels)</code>
でも似たようなことができるが、
第一引数が関数になってるところは<code>invoke()</code>っぽくて、
結果の収納方法を<code>.collate</code>などで調整できるところは<code>by_row()</code>っぽい。</dd>
<dt><code>purrr::map_if(.x, .p, .f, ...)</code></dt>
<dd><code>.p</code>が<code>TRUE</code>になる要素のみ<code>.f()</code>を適用し、残りはそのまま出力。
<code>.p</code>はlogical vectorでもいいし、
<code>.x[[i]]</code>を受け取るpredicate関数でもよい。</dd>
<dd>番号か名前で選ぶには<code>purrr::map_at(.x, .at, .f, ...)</code></dd>
<dt><code>purrr::reduce(.x, .f, ..., .init)</code></dt>
<dd>二変数関数を順々に適用して1つの値を返す。
C++でいう<code>std::accumulate()</code>。</dd>
<dt><code>purrr::accumulate(.x, .f, ..., .init)</code></dt>
<dd>二変数関数を順々に適用し、過程も含めてvectorで返す。
例えば <code>accumulate(1:3, sum)</code> の結果は <code>1 3 6</code> 。
C++でいう<code>std::partial_sum()</code>。</dd>
<dt><code>purrr::invoke(.f, .x=NULL, ..., .env=NULL)</code></dt>
<dd>関数に渡す引数があらかじめlistにまとまってるときに使う<code>do.call()</code>の改良版。</dd>
<dt><code>purrr::invoke_map(.f, .x=list(NULL), ..., .env=NULL)</code></dt>
<dd>関数listを順々に実行してlistで返す。
引数<code>.x</code>は同じ長さのlist of listsか、list of a listをリサイクル。</dd>
<dd>e.g., <code>invoke_map(list(runif, rnorm), list(c(n=3, 0, 1)))</code></dd>
<dd>返り値がすべて同じ型で、それぞれ長さ1だった場合、
特定の型のvectorとして返せる亜種がある:
<code>invoke_map_chr()</code>, <code>invoke_map_dbl()</code>, <code>invoke_map_int()</code>, <code>invoke_map_lgl()</code></dd>
<dd>data.frameを繋げて返す<code>invoke_map_df()</code>も。</dd>
<dt><code>purrr::flatten(.x)</code></dt>
<dd>階層性のあるlistを一段階解消する。
階層なしlistをvector化するには明示的に型指定できる
<code>flatten_lgl()</code>, <code>flatten_int()</code>, <code>flatten_dbl()</code>, <code>flatten_chr()</code>, <code>flatten_df()</code>
のほうが標準の<code>unlist()</code>よりも安心。</dd>
<dt><code>purrr::keep(.x, .p, ...)</code>, <code>discard()</code>, <code>compact()</code></dt>
<dd>listやvectorの要素を <code>.p</code> に応じて取捨選択。
わざわざ関数にするほどでもない気もするが、パイプラインで使いやすい形。</dd>
<dt><code>purrr::split_by(.x, .f, ...)</code>, <code>order_by()</code>, <code>sort_by()</code></dt>
<dd>listやvectorを <code>.f</code> に応じて切ったり並べ替えたり。</dd>
</dl>

<h2 id="data-frame操作">data.frame操作</h2>

<dl>
<dt><code>purrr::dmap(.d, .f, ...)</code></dt>
<dd>data.frameかgrouped_dfを受け取り、列ごとに<code>.f</code>を適用してdata.frameを返す。
全列で長さが揃っていれば怒られないので
<code>dplyr::mutate_all()</code>的にも<code>dplyr::summarise_all()</code>的にも使える。
ただし<code>.f</code>に渡せるのは単一の関数のみで<code>dplyr::funs()</code>は使えない。
対象列を選べる<code>dmap_if()</code>と<code>dmap_at()</code>もある。</dd>
<dt><code>purrr::slice_rows(.d, .cols=NULL)</code></dt>
<dd>指定した列でグループ化してgrouped_dfを返す。
<code>dplyr::group_by_(.dots=.cols)</code> と同じ。</dd>
<dt><code>purrr::by_slice(.d, ..f, ..., .collate=c('list', 'rows', 'cols'), .to='.out', .labels=TRUE)</code></dt>
<dd>grouped_dfを受け取ってグループごとに関数を適用する。
<code>dplyr::do()</code> とほぼ同じ役割で、一長一短。
こちらは出力形式をより柔軟に指定できるが、
中の関数からgrouping variableを参照できないという弱点を持つ。
<code>tidyr::nest() %&gt;% dplyr::mutate()</code> とかのほうがスマートかも。</dd>
<dt><code>purrr::by_row(.d, ..f, ..., .collate=c('list', 'rows', 'cols'), .to='.out', .labels=TRUE)</code></dt>
<dd>data.frame 1行ごとに関数を適用する。
<code>dplyr::rowwise() %&gt;% dplyr::do()</code>的な処理を一撃で書ける。</dd>
<dd><code>.to</code>: 結果listの列名</dd>
<dd><code>.labels</code>: 元の<code>.d</code>の列をラベルとして結果に残すか</dd>
<dd><code>.collate</code>: 結果列の展開方法(下記例)。
とりあえず<code>list</code>にしておいて後で<code>unnest()</code>するのが無難か。</dd>
<dd><code>purrr::invoke_rows()</code>はかなり似ているが、
データと関数の順序が逆になっている点と、
<code>.f</code>が<code>.d</code>の列名で引数を取るという点で異なる。
(<code>by_row()</code>では1行のdata.frameとして受け取って<code>.$col</code>のように参照する)</dd>
</dl>

<pre><code class="language-r">&gt; iris[1:3, 1:2] %&gt;% by_row(~data_frame(x=0:1, y=c('a', 'b')), .collate='list')
Source: local data frame [3 x 3]

  Sepal.Length Sepal.Width           .out
         (dbl)       (dbl)          (chr)
1          5.1         3.5 &lt;tbl_df [2,2]&gt;
2          4.9         3.0 &lt;tbl_df [2,2]&gt;
3          4.7         3.2 &lt;tbl_df [2,2]&gt;
&gt; iris[1:3, 1:2] %&gt;% by_row(~data_frame(x=0:1, y=c('a', 'b')), .collate='rows')
Source: local data frame [6 x 5]

  Sepal.Length Sepal.Width  .row     x     y
         (dbl)       (dbl) (int) (int) (chr)
1          5.1         3.5     1     0     a
2          5.1         3.5     1     1     b
3          4.9         3.0     2     0     a
4          4.9         3.0     2     1     b
5          4.7         3.2     3     0     a
6          4.7         3.2     3     1     b
&gt; iris[1:3, 1:2] %&gt;% by_row(~data_frame(x=0:1, y=c('a', 'b')), .collate='cols')
Source: local data frame [3 x 6]

  Sepal.Length Sepal.Width    x1    x2    y1    y2
         (dbl)       (dbl) (int) (int) (chr) (chr)
1          5.1         3.5     0     1     a     b
2          4.9         3.0     0     1     a     b
3          4.7         3.2     0     1     a     b
</code></pre>

<h2 id="無名関数">無名関数</h2>

<p>ラムダ式とも言う。
チルダで始まる <code>~ a + b</code> のようなものはRではformulaという形式になるが、
<code>purrr</code>のmap系関数はそれを引数<code>.f</code>として受け取ることができる。
formula内部では、第一引数を<code>.x</code>または<code>.</code>として、第二引数を<code>.y</code>として参照する。</p>

<pre><code class="language-r"># with named function
ord = function(x) {strtoi(charToRaw(x), 16L)}
letters %&gt;&gt;% map_int(ord)

# with unnamed function
letters %&gt;&gt;% map_int(function(x) {strtoi(charToRaw(x), 16L)})

# with formula
letters %&gt;&gt;% map_int(~ strtoi(charToRaw(.x), 16L))
</code></pre>

<dl>
<dt><code>purrr::as_function(.f, ...)</code></dt>
<dd>上記の機能を担う重要な関数で、<code>map()</code>内部でも使われている。
formulaを<code>function (.x, .y, . = .x)</code>という無名関数に変換する。</dd>
<dt><code>purrr::partial(...f, ..., .env, .lazy, .first)</code></dt>
<dd>引数を部分的に埋めてある関数を作る。C++でいう <code>std::bind()</code></dd>
</dl>

<h2 id="その他の便利関数">その他の便利関数</h2>

<dl>
<dt><code>purrr::list_along(x)</code></dt>
<dd>引数と同じ長さの空listを作る。</dd>
<dt><code>purrr::set_names(x, nm=x)</code></dt>
<dd>標準の<code>setNames(x=nm, nm)</code>は第二引数のほうが省略不可という気持ち悪い定義だったが、
この改良版ではその心配が解消されている。
長さや型のチェックもしてくれる。</dd>
<dt><code>purrr::transpose(.l)</code></dt>
<dd>行列転置関数<code>t()</code>のlist版。
例えば、pair of lists &lt;=&gt; list of pairs。</dd>
<dd>data.frameに適用するとlist of rowsが得られる。</dd>
</dl>

<h2 id="関連書籍">関連書籍</h2>

<p><a href="https://www.amazon.co.jp/Data-Science-Transform-Visualize-Model/dp/1491910399/ref=as_li_ss_il?_encoding=UTF8&qid=1485613345&sr=1-1-catcorr&linkCode=li3&tag=heavywatal-22&linkId=6133a1fd9babbf590e304ee9f670fa4a" target="_blank"><img border="0" src="//ws-fe.amazon-adsystem.com/widgets/q?_encoding=UTF8&ASIN=1491910399&Format=_SL250_&ID=AsinImage&MarketPlace=JP&ServiceVersion=20070822&WS=1&tag=heavywatal-22" ></a><img src="https://ir-jp.amazon-adsystem.com/e/ir?t=heavywatal-22&l=li3&o=9&a=1491910399" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></p>

</article>
</main>

<nav class="menu">

<div><a href="/about.html">About</a></div>


<div><a href="/research.html">Research Interests</a></div>


<input type="checkbox" id="menu-rstats" checked>
<label for="menu-rstats" class="active">R stats</label>
<ul>
<li><a href="/rstats/intro.html">R自学自習の基礎知識</a></li>
<li><a href="/rstats/config.html">R環境設定</a></li>
<li><a href="/rstats/programming.html">RプログラミングTips</a></li>
<li><a href="/rstats/ggplot2.html">ggplot2</a></li>
<li><a href="/rstats/dplyr.html">dplyr</a></li>
<li class="active"><a href="/rstats/purrr.html">purrr</a></li>
<li><a href="/rstats/tidyr.html">tidyr</a></li>
<li><a href="/rstats/readr.html">readr</a></li>
<li><a href="/rstats/stringr.html">stringr</a></li>
<li><a href="/rstats/foreach.html">foreach/parallel</a></li>
<li><a href="/rstats/devtools.html">devtools</a></li>
<li><a href="/rstats/bioconductor.html">Bioconductor</a></li>
<li><a href="/rstats/rtracklayer.html">rtracklayer</a></li>
<li><a href="/rstats/biomart.html">biomaRt</a></li>
<li><a href="/rstats/ggbio.html">ggbio</a></li>
<li><a href="/rstats/edger.html">edgeR</a></li>
<li><a href="/rstats/topgo.html">topGO</a></li>
<li><a href="/rstats/stan.html">Stan</a></li>
<li><a href="/rstats/rgl.html">rgl</a></li>
<li><a href="/rstats/plyr.html">plyr</a></li>
<li><a href="/rstats/reshape2.html">reshape2</a></li>
</ul>

<input type="checkbox" id="menu-python">
<label for="menu-python">Python</label>
<ul>
<li><a href="/python/install.html">Pythonインストール</a></li>
<li><a href="/python/pip.html">pip</a></li>
<li><a href="/python/ipython.html">IPython</a></li>
<li><a href="/python/biopython.html">BioPython</a></li>
<li><a href="/python/scipy.html">NumPy, SciPy</a></li>
<li><a href="/python/pyqt.html">PyQt</a></li>
<li><a href="/python/concurrent.html">concurrent.futures</a></li>
<li><a href="/python/copy.html">copy</a></li>
<li><a href="/python/matplotlib.html">matplotlib &#43; seaborn</a></li>
<li><a href="/python/setuptools.html">setuptools</a></li>
</ul>

<input type="checkbox" id="menu-cxx">
<label for="menu-cxx">C&#43;&#43;</label>
<ul>
<li><a href="/cxx/boost.html">Boost</a></li>
<li><a href="/cxx/getopt.html">C&#43;&#43;コマンドライン引数</a></li>
<li><a href="/cxx/speed.html">C&#43;&#43;高速化</a></li>
<li><a href="/cxx/clang.html">clang / llvm</a></li>
<li><a href="/cxx/gcc.html">gcc</a></li>
<li><a href="/cxx/random.html">擬似乱数生成器</a></li>
</ul>

<input type="checkbox" id="menu-bio">
<label for="menu-bio">Biology</label>
<ul>
<li><a href="/bio/blast.html">BLAST</a></li>
<li><a href="/bio/dnasp.html">DnaSP</a></li>
<li><a href="/bio/emboss.html">EMBOSS</a></li>
<li><a href="/bio/gene_ontology.html">Gene Ontology</a></li>
<li><a href="/bio/meme.html">MEME</a></li>
<li><a href="/bio/mrbayes.html">MrBayes</a></li>
<li><a href="/bio/paml.html">PAML</a></li>
<li><a href="/bio/popgen.html">Population Genetics</a></li>
<li><a href="/bio/repeatmasker.html">RepeatMasker</a></li>
<li><a href="/bio/samtools.html">SAMtools</a></li>
<li><a href="/bio/stochastic_process.html">Stochastic Process</a></li>
<li><a href="/bio/dadi.html">dadi</a></li>
<li><a href="/bio/mathmorph.html">数理形態学</a></li>
<li><a href="/bio/linear_algebra.html">線形代数</a></li>
<li><a href="/bio/complexnetwork.html">複雑ネットワーク</a></li>
<li><a href="/bio/nig.html">遺伝研スパコン</a></li>
<li><a href="/bio/motif.html">配列モチーフ探索</a></li>
</ul>

<input type="checkbox" id="menu-dev">
<label for="menu-dev">Developer Tools</label>
<ul>
<li><a href="/dev/etc.html">/etc</a></li>
<li><a href="/dev/atom.html">Atom</a></li>
<li><a href="/dev/emacs.html">Emacs</a></li>
<li><a href="/dev/git.html">Git</a></li>
<li><a href="/dev/hugo.html">Hugo</a></li>
<li><a href="/dev/mercurial.html">Mercurial</a></li>
<li><a href="/dev/qt.html">Qt</a></li>
<li><a href="/dev/sh.html">Shell Script</a></li>
<li><a href="/dev/torque.html">TORQUE</a></li>
<li><a href="/dev/tex.html">TeX</a></li>
<li><a href="/dev/autotools.html">autoconf, automake</a></li>
<li><a href="/dev/make.html">make</a></li>
<li><a href="/dev/mount.html">mount</a></li>
<li><a href="/dev/nano.html">nano</a></li>
<li><a href="/dev/rsync.html">rsync</a></li>
<li><a href="/dev/ssh.html">ssh</a></li>
<li><a href="/dev/sshfs.html">sshfs</a></li>
<li><a href="/dev/tmux.html">tmux</a></li>
<li><a href="/dev/vi.html">vi</a></li>
<li><a href="/dev/zsh.html">zsh</a></li>
<li><a href="/dev/nohup.html">プロセス管理</a></li>
<li><a href="/dev/devenv.html">開発環境</a></li>
</ul>

<input type="checkbox" id="menu-linux">
<label for="menu-linux">Linux</label>
<ul>
<li><a href="/linux/centos.html">CentOS 6.5</a></li>
<li><a href="/linux/japanese.html">Linux日本語環境</a></li>
<li><a href="/linux/apt.html">apt/dpkg</a></li>
<li><a href="/linux/ufw.html">ufw</a></li>
</ul>

<input type="checkbox" id="menu-mac">
<label for="menu-mac">Mac</label>
<ul>
<li><a href="/mac/applescript.html">AppleScript</a></li>
<li><a href="/mac/homebrew.html">Homebrew</a></li>
<li><a href="/mac/keyboard.html">Keyboard</a></li>
<li><a href="/mac/macports.html">MacPorts</a></li>
<li><a href="/mac/command.html">Mac固有コマンド</a></li>
<li><a href="/mac/quicklook.html">QuickLook</a></li>
<li><a href="/mac/spotlight.html">Spotlight</a></li>
<li><a href="/mac/winebottler.html">WineBottler</a></li>
<li><a href="/mac/kotoeri.html">ことえり</a></li>
</ul>

<input type="checkbox" id="menu-lectures">
<label for="menu-lectures">Lectures</label>
<ul>
<li><a href="/lectures/verhoef_comm_ecol-11.html">Community Ecology 輪読会 11章</a></li>
<li><a href="/lectures/prml-11-1.html">PRML輪読会 11章1節</a></li>
<li><a href="/lectures/prml-2-1.html">PRML輪読会 2章前半</a></li>
<li><a href="/lectures/prml-3-4.html">PRML輪読会 3章4節</a></li>
<li><a href="/lectures/wakeley-2-2.html">Wakeley輪読会 2章2節</a></li>
</ul>

<input type="checkbox" id="menu-misc">
<label for="menu-misc">Miscellaneous</label>
<ul>
<li><a href="/misc/fonts.html">Fonts</a></li>
<li><a href="/misc/mailman.html">Mailman</a></li>
<li><a href="/misc/vnc.html">VNCによる画面共有</a></li>
<li><a href="/misc/virtualbox.html">VirtualBox</a></li>
</ul>

<div><a href="/tags.html">Tags</a></div>

</nav>

<footer>(ɔ) 2008 岩嵜航 Watal M. Iwasaki</footer>
<script src="/js/highlight.pack.js"></script>
<script>
hljs.configure({languages: ["sh","c++","python","r","tex"]});
hljs.initHighlightingOnLoad();
</script>
</body>
</html>

